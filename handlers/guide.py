from aiogram import Router, F
from aiogram.types import Message
from groq import Groq
from config import GROQ_API_KEY
from prompts import get_guide_prompt
import asyncio

router = Router()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Groq –∫–ª–∏–µ–Ω—Ç–∞
client = Groq(api_key=GROQ_API_KEY)

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö –∫–≤–∏–∑–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ ‚Äî –ë–î)
user_quiz_data = {}

@router.message(F.text.in_(['üìö –ü–æ–ª—É—á–∏—Ç—å –≥–∞–π–¥', 'üìö Get Guide']))
async def generate_guide(message: Message):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≥–∞–π–¥–∞ —á–µ—Ä–µ–∑ Groq"""
    user_id = message.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à—ë–ª –ª–∏ –∫–≤–∏–∑
    if user_id not in user_quiz_data or not user_quiz_data[user_id]:
        await message.answer(
            "‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏—Ç–µ –∫–≤–∏–∑ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏!\n"
            "–ù–∞–∂–º–∏—Ç–µ 'üìù –ü—Ä–æ–π—Ç–∏ –∫–≤–∏–∑ (–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è)'"
        )
        return
    
    await message.answer(
        "‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥–∞–π–¥...\n"
        "Groq —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–æ ‚Äî –æ–±—ã—á–Ω–æ 2-3 —Å–µ–∫—É–Ω–¥—ã ‚ö°"
    )
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–º–ø—Ç
        prompt = get_guide_prompt(user_quiz_data[user_id], lang='ru')
        
        # –ó–∞–ø—Ä–æ—Å –∫ Groq (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ run_in_executor)
        loop = asyncio.get_event_loop()
        response = await loop.run_in_executor(
            None,
            lambda: client.chat.completions.create(
                model="llama-3.1-8b-instant",  # –ë—ã—Å—Ç—Ä–∞—è –∏ –ø–æ–Ω–∏–º–∞–µ—Ç —Ä—É—Å—Å–∫–∏–π
                messages=[
                    {
                        "role": "system",
                        "content": "–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Å–∞–º–æ–ø–æ–º–æ—â–∏ –ø—Ä–∏ —Ç—Ä–µ–≤–æ–≥–µ. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, —Å —ç–º–ø–∞—Ç–∏–µ–π."
                    },
                    {
                        "role": "user",
                        "content": prompt
                    }
                ],
                max_tokens=1200,
                temperature=0.7,
                top_p=0.9
            )
        )
        
        guide_text = response.choices[0].message.content
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥–∞–π–¥
        await message.answer(guide_text, parse_mode=None)
        
        await message.answer(
            "‚úÖ –ì–∞–π–¥ –≥–æ—Ç–æ–≤! –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–º.\n\n"
            "üí° –°–æ–≤–µ—Ç: –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç '–°–∫–æ—Ä–æ–π –ø–æ–º–æ—â–∏' –∫–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî "
            "—ç—Ç–æ —É–∫—Ä–µ–ø–ª—è–µ—Ç –Ω–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–≤—è–∑–∏ –∏ —Å–Ω–∏–∂–∞–µ—Ç –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–∏—Å—Ç—É–ø–æ–≤."
        )
        
    except Exception as e:
        error_msg = str(e)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∏–º–∏—Ç–æ–≤ Groq
        if "rate_limit" in error_msg.lower() or "429" in error_msg:
            await message.answer(
                "‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò (100/—á–∞—Å).\n"
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏ –Ω–∏–∂–µ:\n\n"
                "üßò –¢–µ—Ö–Ω–∏–∫–∞ 5-4-3-2-1:\n"
                "5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏—Ç–µ ‚Üí 4, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–æ–≥–∞–µ—Ç–µ ‚Üí 3, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª—ã—à–∏—Ç–µ ‚Üí "
                "2, –∫–æ—Ç–æ—Ä—ã–µ –Ω—é—Ö–∞–µ—Ç–µ ‚Üí 1, –∫–æ—Ç–æ—Ä—É—é –ø—Ä–æ–±—É–µ—Ç–µ"
            )
        else:
            await message.answer(
                f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {error_msg[:200]}\n\n"
                "–ù–æ –Ω–µ –≤–æ–ª–Ω—É–π—Ç–µ—Å—å! –í–æ—Ç –±–∞–∑–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞:\n"
                "üå¨Ô∏è –î—ã—Ö–∞–Ω–∏–µ 4-7-8:\n"
                "–í–¥–æ—Ö 4 —Å–µ–∫ ‚Üí –ó–∞–¥–µ—Ä–∂–∫–∞ 7 —Å–µ–∫ ‚Üí –í—ã–¥–æ—Ö 8 —Å–µ–∫ ‚Üí –ü–æ–≤—Ç–æ—Ä–∏—Ç—å 4 —Ä–∞–∑–∞"
            )
